# Test Alert
input_boolean:
  test_alert:
    name: Test Alert

  def_com_vp2:
    name: Defaut Comm VP2 si Off

  def_com_linky:
    name: Defaut Comm Linky si Off

# Permet de d'inhiber l'alarme PAC quand la PAC est arretée, l'été par exemple
  inhib_alarme_pac:
    name: Inhib Alarm PAC

# Permet de d'inhiber l'alarme Linky
  inhib_alarme_linky:
    name: Inhib Alarm Linky


# Surveillance de la temperature du congelateur        
template:
  binary_sensor:
# Surveillance de la temperature du congelateur     
# normalement sur off
    - name: "alarme_temp_congelo_haute"
      state: >-
        {{ states('sensor.temp_congelo_garage')|float(default=0)>-10 }}
      device_class: "problem"

# Surveillance discordance PAC entre l'état du thermostat et l'état du switch de commande   
# normalement sur on  
    - name: "alarme_discord_pac"
      state: >-
        {% set a=states("sensor.puissance_pac_rpac")| float(default=0)>400 %}
        {% set b=states("switch.altherma") %}
        {{ (a==true and b=="on") or (a==false and b=="off") }}
      device_class: "connectivity"
        
# Surveillance status PAC
# normalement sur on
    - name: "alarme_status_pac"
      state: >-
        {% set a=states("sensor.esp_altherma_status") %}
        {{ a=="Online" }}
      device_class: "connectivity"

# Surveillance porte garage
# normalement sur on
    - name: "alarme_porte_garage"
      state: >-
        {% set a=is_state("sun.sun", "below_horizon") %}
        {% set b=states("binary_sensor.porte_garage_fermee") %}
        {{ a==True and b=="off" }}
      device_class: "problem"

# Surveillance porte sous sol
# normalement sur on
    - name: "alarme_porte_sous_sol"
      state: >-
        {% set a=is_state("sun.sun", "below_horizon") %}
        {% set b=states("binary_sensor.porte_ssol_fermee") %}
        {{ a==True and b=="off" }}
      device_class: "problem"

# Surveillance porte cellier
# Sur on si fermée
    - name: "alarme_porte_cellier"
      state: >-
        {% set a=is_state("sun.sun", "below_horizon") %}
        {% set b=states("binary_sensor.porte_cellier") %}
        {{ a==True and b=="on" }}
      device_class: "problem"

# Regoupement des alarmes => 
    - name: "Alarmes Importantes"
#      entity_id: "alarmes_importantes"
      state: >-
        {%set a=states("binary_sensor.alarme_porte_cellier")%}
        {%set b=states("binary_sensor.alarme_porte_garage")%}
        {%set c=states("binary_sensor.alarme_porte_sous_sol")%}
        {%set d=states("binary_sensor.alarme_status_pac")%}
        {%set e=states("binary_sensor.alarme_discord_pac")%}
        {%set f=states("binary_sensor.alarme_temp_congelo_haute")%}
        {%set g=states("binary_sensor.ping_reseau")%}
        {%set h=states("binary_sensor.esp_reseau")%}                                                        
        {%set i=states("binary_sensor.uptime_reseau")%}
        {%set j=states("binary_sensor.porte_frigo")%}
        {%set k=states("input_boolean.def_com_vp")%}
        {{not(a=="off" and b=="off" and c=="off" and d=="on" and e=="on" and f=="off" and g=="on" and h=="on"and i=="on" and j=="off")}}
      device_class: "problem"
