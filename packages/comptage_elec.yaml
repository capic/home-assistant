utility_meter:
# usage jour  
  energy_total_usage_daily:
    source: sensor.pzem_totale_energy
    cycle: daily
    tariffs:
      - hp
      - hc
  energy_total_linky_usage_daily:
    source: sensor.linky_conso_totale_hphc
    cycle: daily
    tariffs:
      - hp
      - hc
  energy_pisc_usage_daily:
    source: sensor.pzem_pisc_energy
    cycle: daily
    tariffs:
      - hp
      - hc
  energy_sdb_usage_daily:
    source: sensor.pzem_sdb_energie
    cycle: daily
    tariffs:
      - hp
      - hc
  energy_pac1_usage_daily:
    source: sensor.energy_pac_p_kw
    cycle: daily
    tariffs:
      - hp
      - hc
  energy_ecs1_usage_daily:
    source: sensor.energy_ecs_p_kw
    cycle: daily
    tariffs:
      - hp
      - hc
  energy_mal_usage_daily:
    source: sensor.energy_pc_mal
    cycle: daily
    tariffs:
      - hp
      - hc
  energy_wc_usage_daily:
    source: sensor.energy_pc_wc
    cycle: daily
    tariffs:
      - hp
      - hc
  energy_autres_usage_daily:
    source: sensor.energy_autres
    cycle: daily
    tariffs:
      - hp
      - hc
      
# usage semaine
  energy_total_usage_weekly:
    source: sensor.pzem_totale_energy
    cycle: weekly
    tariffs:
      - hp
      - hc
  energy_total_linky_usage_weekly:
    source: sensor.linky_conso_totale_hphc
    cycle: weekly
    tariffs:
      - hp
      - hc
  energy_pisc_usage_weekly:
    source: sensor.pzem_pisc_energy
    cycle: weekly
    tariffs:
      - hp
      - hc
  energy_sdb_usage_weekly:
    source: sensor.pzem_sdb_energie
    cycle: weekly
    tariffs:
      - hp
      - hc
  energy_pac1_usage_weekly:
    source: sensor.energy_pac_p_kw
    cycle: weekly
    tariffs:
      - hp
      - hc
  energy_ecs1_usage_weekly:
    source: sensor.energy_ecs_p_kw
    cycle: weekly
    tariffs:
      - hp
      - hc
  energy_mal_usage_weekly:
    source: sensor.energy_pc_mal
    cycle: weekly
    tariffs:
      - hp
      - hc
  energy_autres_usage_weekly:
    source: sensor.energy_autres
    cycle: weekly
    tariffs:
      - hp
      - hc
# usage mois
  energy_total_usage_monthly:
    source: sensor.pzem_totale_energy
    cycle: monthly
    tariffs:
      - hp
      - hc
  energy_total_linky_usage_monthly:
    source: sensor.linky_conso_totale_hphc
    cycle: monthly
    tariffs:
      - hp
      - hc
  energy_pisc_usage_monthly:
    source: sensor.pzem_pisc_energy
    cycle: monthly
    tariffs:
      - hp
      - hc
  energy_sdb_usage_monthly:
    source: sensor.pzem_sdb_energie
    cycle: monthly
    tariffs:
      - hp
      - hc
  energy_pac1_usage_monthly:
    source: sensor.energy_pac_p_kw
    cycle: monthly
    tariffs:
      - hp
      - hc
  energy_ecs1_usage_monthly:
    source: sensor.energy_ecs_p_kw
    cycle: monthly
    tariffs:
      - hp
      - hc
  energy_mal_usage_monthly:
    source: sensor.energy_pc_mal
    cycle: monthly
    tariffs:
      - hp
      - hc
  energy_autres_usage_monthly:
    source: sensor.energy_autres
    cycle: monthly
    tariffs:
      - hp
      - hc
#usage an
  energy_total_usage_yearly:
    source: sensor.pzem_totale_energy
    cycle: yearly
    tariffs:
      - hp
      - hc
  energy_total_linky_usage_yearly:
    source: sensor.linky_conso_totale_hphc
    cycle: yearly
    tariffs:
      - hp
      - hc
  energy_pisc_usage_yearly:
    source: sensor.pzem_pisc_energy
    cycle: yearly
    tariffs:
      - hp
      - hc
  energy_sdb_usage_yearly:
    source: sensor.pzem_sdb_energie
    cycle: yearly
    tariffs:
      - hp
      - hc
  energy_pac1_usage_yearly:
    source: sensor.energy_pac_p_kw
    cycle: yearly
    tariffs:
      - hp
      - hc
  energy_ecs1_usage_yearly:
    source: sensor.energy_ecs_p_kw
    cycle: yearly
    tariffs:
      - hp
      - hc
  energy_mal_usage_yearly:
    source: sensor.energy_pc_mal
    cycle: yearly
    tariffs:
      - hp
      - hc
  energy_autres_usage_yearly:
    source: sensor.energy_autres
    cycle: yearly
    tariffs:
      - hp
      - hc

template:
# Consommation journalière HP + HC - addition des utility meter
  - sensor:
    - name: "Energie Totale Jour"
      unique_id: "energy_total_daily"
      state: >-
        {% set p = states('sensor.energy_total_usage_daily_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_total_usage_daily_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"

    - name: "Energie Totale Linky Jour"
      unique_id: "energy_total_linky_daily"
      state: >-
        {% set p = states('sensor.energy_total_linky_usage_daily_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_total_linky_usage_daily_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "Energie Piscine Jour"
      unique_id: "energy_pisc_daily" 
      state: >-
        {% set p = states('sensor.energy_pisc_usage_daily_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_pisc_usage_daily_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "Energie SdB Jour"
      unique_id: "energy_sdb_daily"    
      state: >-
        {% set p = states('sensor.energy_sdb_usage_daily_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_sdb_usage_daily_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "Energie PAC Jour"
      unique_id: "energy_pac1_daily"
      state: >-
        {% set p = states('sensor.energy_pac1_usage_daily_hp') | float(default=0) | round(3) %}
        {% set o = states('sensor.energy_pac1_usage_daily_hc') | float(default=0) | round(3) %}
        {{ (o + p) | round(3) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "Energie ECS Jour"
      unique_id: "energy_ecs1_daily"
      state: >-
        {% set p = states('sensor.energy_ecs1_usage_daily_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_ecs1_usage_daily_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "Energie MàL Jour"
      unique_id: "energy_mal_daily"
      state: >-
        {% set p = states('sensor.energy_mal_usage_daily_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_mal_usage_daily_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "Energie WC Jour"
      unique_id: "energy_wc_daily"
      state: >-
        {% set p = states('sensor.energy_wc_usage_daily_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_wc_usage_daily_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  


    - name: "Energie Autres Jour"
      unique_id: "energy_autres_daily"
      state: >-
        {% set p = states('sensor.energy_autres_usage_daily_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_autres_usage_daily_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"

# Consommation semaine HP + HC
    - name: "energy_total_weekly"
      state: >-
        {% set p = states('sensor.energy_total_usage_weekly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_total_usage_weekly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "Energie Totale Linky weekly"
      unique_id: "energy_total_linky_weekly"
      state: >-
        {% set p = states('sensor.energy_total_linky_usage_weekly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_total_linky_usage_weekly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  
    
    - name: "energy_pisc_weekly"
      state: >-
        {% set p = states('sensor.energy_pisc_usage_weekly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_pisc_usage_weekly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "energy_sdb_weekly"
      state: >-
        {% set p = states('sensor.energy_sdb_usage_weekly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_sdb_usage_weekly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "energy_pac1_weekly"
      state: >-
        {% set p = states('sensor.energy_pac1_usage_weekly_hp') | float(default=0) | round(3) %}
        {% set o = states('sensor.energy_pac1_usage_weekly_hc') | float(default=0) | round(3) %}
        {{ (o + p) | round(3) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "energy_ecs1_weekly"
      state: >-
        {% set p = states('sensor.energy_ecs1_usage_weekly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_ecs1_usage_weekly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total" 

    - name: "energy_mal_weekly"
      state: >-
        {% set p = states('sensor.energy_mal_usage_weekly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_mal_usage_weekly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total" 

    - name: "energy_autres_weekly"
      state: >-
        {% set p = states('sensor.energy_autres_usage_weekly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_autres_usage_weekly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  


# Consommation mensuelle HP + HC
    - name: "energy_total_monthly"
      state: >-
        {% set p = states('sensor.energy_total_usage_monthly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_total_usage_monthly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "Energie Totale Linky Mois"
      unique_id: "energy_total_linky_monthly"
      state: >-
        {% set p = states('sensor.energy_total_linky_usage_monthly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_total_linky_usage_monthly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "energy_pisc_monthly"
      state: >-
        {% set p = states('sensor.energy_pisc_usage_monthly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_pisc_usage_monthly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "energy_sdb_monthly"
      state: >-
        {% set p = states('sensor.energy_sdb_usage_monthly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_sdb_usage_monthly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "energy_pac1_monthly"
      state: >-
        {% set p = states('sensor.energy_pac1_usage_monthly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_pac1_usage_monthly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "energy_ecs1_monthly"
      state: >-
        {% set p = states('sensor.energy_ecs1_usage_monthly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_ecs1_usage_monthly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "energy_mal_monthly"
      state: >-
        {% set p = states('sensor.energy_mal_usage_monthly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_mal_usage_monthly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"        

    - name: "energy_autres_monthly"
      state: >-
        {% set p = states('sensor.energy_autres_usage_monthly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_autres_usage_monthly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

# Consommation annuelle HP + HC
    - name: "energy_total_yearly"
      state: >-
        {% set p = states('sensor.energy_total_usage_yearly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_total_usage_yearly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "Energie Totale Linky An"
      unique_id: "energy_total_linky_yearly"
      state: >-
        {% set p = states('sensor.energy_total_linky_usage_yearly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_total_linky_usage_yearly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "energy_pisc_yearly"
      state: >-
        {% set p = states('sensor.energy_pisc_usage_yearly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_pisc_usage_yearly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "energy_sdb_yearly"
      state: >-
        {% set p = states('sensor.energy_sdb_usage_yearly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_sdb_usage_yearly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "energy_pac1_yearly"
      state: >-
        {% set p = states('sensor.energy_pac1_usage_yearly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_pac1_usage_yearly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "energy_ecs1_yearly"
      state: >-
        {% set p = states('sensor.energy_ecs1_usage_yearly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_ecs1_usage_yearly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

    - name: "energy_mal_yearly"
      state: >-
        {% set p = states('sensor.energy_mal_usage_yearly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_mal_usage_yearly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"        

    - name: "energy_autres_yearly"
      state: >-
        {% set p = states('sensor.energy_autres_usage_yearly_hp') | float(default=0) | round(2) %}
        {% set o = states('sensor.energy_autres_usage_yearly_hc') | float(default=0) | round(2) %}
        {{ (o + p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"  

# Cout de l'Energie
# le kWh HP et HC sont calculés dans excel en fonction des factures recues

    - name: "Cout Energy Total Jour HPHC"
      state: >-
        {% set hp = states('sensor.energy_total_usage_daily_hp') | float(default=0) | round(2) %}
        {% set hc = states('sensor.energy_total_usage_daily_hc') | float(default=0) | round(2) %}
        {% set chp = states('input_number.cout_kwh_hp') | float(default=0) | round(5) %}
        {% set chc = states('input_number.cout_kwh_hc') | float(default=0) | round(5) %}
        {{(hc*chc + hp*chp) | round(2) }}
      unit_of_measurement: "€"
      device_class: "monetary"
      state_class: "total"  
      unique_id: "cout_energy_total_jour_hphc"

    - name: "Cout Energy Total Jour HP"
      state: >-
        {% set hp = states('sensor.energy_total_usage_daily_hp') | float(default=0) | round(2) %}
        {% set chp = states('input_number.cout_kwh_hp') | float(default=0) | round(5) %}
        {{(hp*chp) | round(2) }}
      unit_of_measurement: "€"
      device_class: "monetary"
      state_class: "total"  
      unique_id: "cout_energy_total_jour_hp"
      
    - name: "Cout Energy Total Jour HC"
      state: >-
        {% set hc = states('sensor.energy_total_usage_daily_hc') | float(default=0) | round(2) %}
        {% set chc = states('input_number.cout_kwh_hc') | float(default=0) | round(5) %}
        {{(hc*chc) | round(2) }}
      unit_of_measurement: "€"
      device_class: "monetary"
      state_class: "total"  
      unique_id: "cout_energy_total_jour_hc"


input_number:
  # utilisé pour simuler la température de l'eau pendant les test
  cout_kwh_hp:
    name: Cout du Kwh HP
    min: 0
    max: 10
    unit_of_measurement: €
    icon: mdi:currency-eur
    step: 0.00001
    mode: box

  cout_kwh_hc:
    name: Cout du Kwh HC
    min: 0
    max: 10
    unit_of_measurement: €
    icon: mdi:currency-eur
    step: 0.00001
    mode: box


