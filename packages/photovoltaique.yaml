####################################################
#                                                  #
#                 PHOTOVOLTAIQUE                   #
#                                                  #
####################################################
input_boolean:

  valid_delestage:
    name: validation Delestage PV
    icon: mdi:power-settings

  mem_delestage:
    name: memoire Delestage PV
    icon: mdi:power-settings

input_number:
  # Seuil Délestage
  seuil_delestage_pv:
    name: Seuil Délestage PV
    min: 0
    max: 1800
    unit_of_measurement: W
    icon: mdi:flash
    mode: box


template:
  - sensor:

# Envoy:  Energie soutirée et injectée depuis le reseau -> Conso - Prod en kWh
# calculee dans "entrées"

# Envoy: Puissance injectée sur le réseau - Integration dans "Entrées"
# binary_sensor.linky_sens_energie_active=off 
    - name: "Envoy Puissance Injectée Réseau"
      unique_id: "envoy_puissance_injectee_reseau"
      device_class: "power"
      state_class: "measurement"
      unit_of_measurement: "W"
      state: >-
        {{ [0, (states('sensor.envoy_122103023124_current_power_production') | int - states('sensor.envoy_122103023124_current_power_consumption') | int)] | max }}

# Envoy: Puissance soutirée sur le réseau
# binary_sensor.linky_sens_energie_active = on
    - name: "Envoy Puissance soutirée Réseau"
      unique_id: "envoy_puissance_soutiree_reseau"
      device_class: "power"
      state_class: "measurement"
      unit_of_measurement: "W"
      state: >-
        {{ [0, (states('sensor.envoy_122103023124_current_power_consumption') | int - states('sensor.envoy_122103023124_current_power_production') | int)] | max }}

    - name: "Envoy pv conso net"
      unique_id: "envoy_pv_conso_net"
      device_class: "power"
      state_class: "measurement"
      unit_of_measurement: "W"
      state: >-
        {% set solar = states('sensor.envoy_122103023124_current_power_consumption') | int %}
        {% set house = states('sensor.envoy_122103023124_current_power_production') | int %}
        {% if house > solar %}
          {{ solar }}
        {% else %}
          {{ house }}
        {%endif%} 

    - name: "Envoy energie import export"
      unique_id: "envoy_energie_import_export"
      state: >-
        {% if (states('sensor.envoy_122103023124_current_power_production') | int - states('sensor.envoy_122103023124_current_power_consumption') | int) > 0 %}Export{% else %}Import{% endif %}
      icon: "{% if (states('sensor.envoy_122103023124_current_power_production') | int - states('sensor.envoy_122103023124_current_power_consumption') | int) > 0 %}mdi:arrow-up-box{% else %}mdi:arrow-down-box{% endif %}"

    - name: "Envoy total conso maison"
      unique_id: "envoy_total_conso_maison"
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total" 
      state: >-
        {% set import = states('sensor.envoy_energie_soutiree_reseau_jour') | int %}
        {% set export = states('sensor.envoy_energie_injectee_reseau_jour') | int %}
        {% set prod = states('sensor.envoy_energie_totale_produite_jour') | int %}
        {{ prod + import - export }}

# Envoy: Convertion en kWh de la consommation energie jour
    - name: "Envoy Energie Totale Consommée Jour"
      unique_id: "envoy_energie_totale_conso_jour"
      state: >-
        {% set p = states('sensor.envoy_122103023124_today_s_energy_consumption') | float(default=0) | round(2) %}
        {{ (p / 1000) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"      

# Envoy: Convertion en kWh de la production energie jour
    - name: "Envoy Energie Totale Produite Jour"
      unique_id: "envoy_energie_totale_prod_jour"
      state: >-
        {% set p = states('sensor.envoy_122103023124_today_s_energy_production') | float(default=0) | round(2) %}
        {{ (p / 1000) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total" 
      

    - name: "Energie injectee Jour 2"
      unique_id: "energie_injectee_jour_2"
      state: >-
        {% set p = states('sensor.energie_injectee_reseau_jour') | float(default=0) | round(2) %}
        {{ ( p) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"