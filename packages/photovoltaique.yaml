####################################################
#                                                  #
#                 PHOTOVOLTAIQUE                   #
#                                                  #
####################################################
input_boolean:

  valid_delestage:
    name: validation Delestage PV
    icon: mdi:power-settings

  mem_delestage:
    name: memoire Delestage PV
    icon: mdi:power-settings

input_number:
  # Seuil Délestage
  seuil_delestage_pv:
    name: Seuil Délestage PV
    min: 0
    max: 1800
    unit_of_measurement: W
    icon: mdi:flash
    mode: box


template:
  - sensor:

# Envoy:  Energie soutirée depuis le reseau -> Conso - Prod en kWh
    - name: "Envoy Energie Totale Soutirée Jour"
      unique_id: "envoy_energie_totale_soutiree_jour"
      state: >-
        {% set prod = states('sensor.envoy_122103023124_today_s_energy_production') | float(default=0) | round(2) %}
        {% set conso = states('sensor.envoy_122103023124_today_s_energy_consumption') | float(default=0) | round(2) %}
        {% if conso>prod %}
            {{ (conso - prod)/1000 | round(2) }}
        {% else%}
          0
        {%endif%}        
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"

# Envoy: Puissance injectée sur le réseau - Integration dans "Entrées"
# binary_sensor.linky_sens_energie_active=off 
    - name: "Envoy Puissance Injectée Réseau"
      unique_id: "envoy_puissance_injectee_reseau"
      device_class: "power"
      state_class: "measurement"
      unit_of_measurement: "W"
      state: >-
        {% set p_active = states('binary_sensor.linky_sens_energie_active') %}
        {% set conso = states('sensor.envoy_122103023124_current_power_consumption') | float(default=0) | round(2) %}
        {% if p_active == 'off'%}
          {{ conso }}
        {% else %}
          0
        {%endif%}
# Envoy: Puissance soutirée sur le réseau
# binary_sensor.linky_sens_energie_active = on
    - name: "Envoy Puissance soutirée Réseau"
      unique_id: "envoy_puissance_soutiree_reseau"
      device_class: "power"
      state_class: "measurement"
      unit_of_measurement: "W"
      state: >-
        {% set p_active = states('binary_sensor.linky_sens_energie_active') %}
        {% set conso = states('sensor.envoy_122103023124_current_power_consumption') | float(default=0) | round(2) %}
        {% set prod = states('sensor.envoy_122103023124_current_power_production') | float(default=0) | round(2) %}       
        {% if p_active == 'on'%}
          {{ conso-prod }}
        {% else %}
          0
        {%endif%} 

# Permet d'animer la Grille Tesla
    - name: "grid_entity"
      unique_id: "grid_entity"
      device_class: "power"
      state_class: "measurement"
      unit_of_measurement: "W"
      state: >-
        {% set souti = states('sensor.envoy_puissance_soutiree_reseau') | float(default=0) | round(2) %}
        {% set inject = states('sensor.envoy_puissance_injectee_reseau') | float(default=0) | round(2) %}
        {% if souti > 0 %}
          {{ souti }}        
        {% else %}
          {{ inject }}      
        {%endif%} 

    - name: "house_entity"
      unique_id: "house_entity"
      device_class: "power"
      state_class: "measurement"
      unit_of_measurement: "W"
      state: >-
        {% set p_active = states('binary_sensor.linky_sens_energie_active') %}
        {% set prod = states('sensor.envoy_122103023124_current_power_production') | float(default=0) | round(2) %}       
        {% set souti = states('sensor.envoy_puissance_soutiree_reseau') | float(default=0) | round(2) %}
        {% set inject = states('sensor.envoy_puissance_injectee_reseau') | float(default=0) | round(2) %}
        {% if p_active == 'on'%}
          {{ prod+souti }}
        {% else %}
          {{ prod-inject}}
        {%endif%} 

    - name: "grid_to_house_entity"
      unique_id: "grid_to_house_entity"
      device_class: "power"
      state_class: "measurement"
      unit_of_measurement: "W"
      state: >-
        {% set souti = states('sensor.envoy_puissance_soutiree_reseau') | float(default=0) | round(2) %}
        {{ souti | round(2) }}

    - name: "generation_to_house_entity"
      unique_id: "generation_to_house_entity"
      device_class: "power"
      state_class: "measurement"
      unit_of_measurement: "W"
      state: >-
        {% set prod = states('sensor.envoy_122103023124_current_power_production') | float(default=0) | round(2) %}
        {% set inj = states('sensor.envoy_puissance_injectee_reseau') | float(default=0) | round(2) %}
        {{ (prod-inj) | round(2) }}

    - name: "generation_to_grid_entity"
      unique_id: "generation_to_grid_entity"
      device_class: "power"
      state_class: "measurement"
      unit_of_measurement: "W"
      state: >-
        {% set inj = states('sensor.envoy_puissance_injectee_reseau') | float(default=0) | round(2) %}
        {{ inj | round(2) }}


# Envoy: Convertion en kWh de la consommation energie jour
    - name: "Envoy Energie Totale Consommée Jour"
      unique_id: "envoy_energie_totale_conso_jour"
      state: >-
        {% set p = states('sensor.envoy_122103023124_today_s_energy_consumption') | float(default=0) | round(2) %}
        {{ (p / 1000) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"      

# Envoy: Convertion en kWh de la production energie jour
    - name: "Envoy Energie Totale Produite Jour"
      unique_id: "envoy_energie_totale_prod_jour"
      state: >-
        {% set p = states('sensor.envoy_122103023124_today_s_energy_production') | float(default=0) | round(2) %}
        {{ (p / 1000) | round(2) }}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"       

# Envoy Energie injectée sur le reseau Jour
    - name: "envoy_energie_injectee_reseau_jour"
      unique_id: "envoy_energie_injectee_reseau_jour"
      state: >-
        {% set prod = states('sensor.envoy_122103023124_today_s_energy_production') | float(default=0) | round(2) /1000 %}
        {% set conso = states('sensor.energie_totale_jour') | float(default=0) | round(2) %}
        {% set conso2 = states('sensor.envoy_122103023124_today_s_energy_consumption') | float(default=0) | round(2) %}
        {% if prod>conso2 %}
          {{ (prod - conso2) | round(2) }}
        {% else%}
          0
        {%endif%}
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"    