# Victron
modbus:
  - name: cerbo
    host: 192.168.0.86
    type: tcp
    port: 502
    switches:
      - name: "MP2 cde"
        slave: 227
        address: 33
        command_on: 3
        command_off: 4
        verify:
          input_type: holding
          address: 33
          state_on: 3
          state_off: 4
    sensors:
      # SYSTEM
      # Switch Position
      # 1=Charger Only;2=Inverter Only;3=On;4=Off
      - name: "MP2 position Inter"
        slave: 227
        address: 33
        data_type: uint16
        scale: 1

      # Status bus VE
      # 0=Off;1=Low Power;2=Fault;3=Bulk;4=Absorption;5=Float;6=Storage;
      # 7=Equalize;8=Passthru;9=Inverting;10=Power assist;11=Power supply;252=External control

      - name: "MP2 Status bus VE"
        unique_id: "mp2_status_bus_ve"
        slave: 227
        address: 31
        data_type: uint16
        scale: 1

        # AC Consumption L1
      - name: "MP2 Conso AC L1"
        unique_id: "mp2_conso_ac_l1"
        data_type: uint16
        unit_of_measurement: "W"
        slave: 100
        address: 817
        scale: 1
        device_class: power
        state_class: measurement

      #Grid L1
      - name: "MP2 Grid L1"
        unique_id: "mp2_grid_l1"
        data_type: int16
        unit_of_measurement: "W"
        slave: 100
        address: 820
        scale: 1
        device_class: power
        state_class: measurement

      # Active input source
      # 0=Unknown;1=Grid;2=Generator;3=Shore power;240=Not connected
      - name: "MP2 Source Puissance"
        unique_id: "mp2_source_puissance"
        data_type: int16
        slave: 100
        address: 826
        scale: 1

      # Battery Voltage (System)
      - name: "MP2 Tension Batteries"
        unique_id: "mp2_tension_batteries"
        data_type: uint16
        unit_of_measurement: "V"
        slave: 100
        address: 840
        scale: 0.1
        device_class: voltage
        state_class: measurement

      # Battery Current (System)
      - name: "MP2 Intensité Batteries"
        unique_id: "mp2_intensite_batteries"
        data_type: int16
        unit_of_measurement: "A"
        slave: 100
        address: 841
        scale: 0.1
        device_class: current
        state_class: measurement

      # Battery Power (System)
      # positive en charge-negatif en décharge
      - name: "MP2 Puissance Batteries"
        unique_id: "mp2_puissance_batteries"
        data_type: int16
        unit_of_measurement: "W"
        slave: 100
        address: 842
        scale: 1
        device_class: power
        state_class: measurement

      # Battery state (System)
      # 0=idle;1=charging;2=discharging
      - name: "MP2 Status Batteries"
        unique_id: "mp2_status_batteries"
        data_type: int16
        slave: 100
        address: 844
        scale: 1

      # PV - DC-coupled power
      - name: "MP2 Puissance PV"
        unique_id: "mp2_puissance_pv"
        data_type: uint16
        unit_of_measurement: "W"
        slave: 100
        address: 850
        scale: 1
        device_class: power
        state_class: measurement

      # DC System Power
      - name: "MP2 Puissance reseau DC "
        unique_id: "mp2_puissance_reseau_dc"
        data_type: int16
        unit_of_measurement: "W"
        slave: 100
        address: 860
        scale: 1
        device_class: power
        state_class: measurement

# Modbus Smart Shunt
        # State of charge - SOC
        # Smart Shunt
      - name: "MP2 SS Tension Batteries"
        unique_id: "mp2_ss_tension_batteries"
        data_type: uint16
        unit_of_measurement: "V"
        slave: 223
        address: 259
        scale: 0.1
        device_class: voltage
        state_class: measurement

      - name: "MP2 SS Tension Start Batteries"
        unique_id: "mp2_ss_tension_start_batteries"
        data_type: uint16
        unit_of_measurement: "V"
        slave: 223
        address: 260
        scale: 0.1
        device_class: voltage
        state_class: measurement

      - name: "MP2 SS Intensité Batteries"
        unique_id: "mp2_ss_intensite_batteries"
        data_type: int16
        unit_of_measurement: "A"
        slave: 223
        address: 261
        scale: 0.1
        device_class: current
        state_class: measurement

      - name: "MP2 SS Conso Ah Batteries"
        unique_id: "mp2_ss_conso_ah_batteries"
        data_type: int16
        unit_of_measurement: "Ah"
        slave: 223
        address: 265
        scale: 0.1
        device_class: current
        state_class: measurement

      - name: "MP2 Niveau Charge Batteries"
        unique_id: "mp2_niveau_charge_batteries"
        data_type: uint16
        unit_of_measurement: "%"
        slave: 223
        address: 266
        scale: 0.1
        device_class: battery
        state_class: measurement

      # Time to go
      - name: "MP2 Temps restant batteries"
        data_type: uint16
        unit_of_measurement: "seconds"
        slave: 223
        address: 303
        scale: 100

      - name: "MP2 Temps depuis derniere pleine batteries"
        data_type: uint16
        unit_of_measurement: "seconds"
        slave: 223
        address: 289
        scale: 0

      # Energy Décharge
      - name: "MP2 Energy décharge batteries brut"
        unique_id: "mp2_energy_decharge_batteries_brut"
        data_type: uint16
        slave: 223
        address: 301
        scale: 1
        unit_of_measurement: "kWh"
        device_class: "energy"
        state_class: "total"

      # Energy Charge
      - name: "MP2 Energy charge batteries brut"
        unique_id: "mp2_energy_charge_batteries_brut"
        data_type: uint16
        slave: 223
        address: 302
        scale: 1
        unit_of_measurement: "kWh"
        device_class: "energy"
        state_class: "total"

# Modbus MP2
      # DC System Power
      - name: "MP2 Puissance Sortie 1"
        unique_id: "mp2_puissance_sortie_1"
        data_type: int16
        unit_of_measurement: "W"
        slave: 227
        address: 23
        scale: 1
        device_class: power
        state_class: measurement

# Energie
      # Energy from AC-In 1 to AC-out
      - name: "MP2 Energy from AC-In 1 to AC-out"
        data_type: uint16
        slave: 227
        address: 74
        scale: 1
        unit_of_measurement: "kWh"
        device_class: "energy"
        state_class: "total"

      # Energy from AC-out to AC-in 1 (reverse fed PV)
      - name: "MP2 Energy from AC-out to AC-in 1"
        data_type: uint16
        slave: 227
        address: 82
        scale: 1
        unit_of_measurement: "kWh"
        device_class: "energy"
        state_class: "total"

      # Energy from battery to AC-in 1
      - name: "MP2 Energy from battery to AC-in 1"
        data_type: uint16
        slave: 227
        address: 86
        scale: 1
        unit_of_measurement: "kWh"
        device_class: "energy"
        state_class: "total"



template:
  - sensor:
    # Affichage Status bus VE
      # 0=Off;1=Low Power;2=Fault;3=Bulk;4=Absorption;5=Float;6=Storage;
      # 7=Equalize;8=Passthru;9=Inverting;10=Power assist;11=Power supply;252=External control

    - name: "Mp2 Affichage Status Bus VE"
      unique_id: "mp2_affichage_status_bus_ve"
      state: >-
        {% set st = states('sensor.mp2_status_bus_ve') | int(default=0) %}
        {% for num, text in [(0, 'Off'), (1, 'Low power'),(2, 'Defaut')
        ,(3, 'Bulk'),(4, 'Absorption'),(5, 'Float'),(6, 'Stockage')
        ,(7, 'Equalize'),(8, 'Traverse'),(9, 'Inverser'),
        (10, 'Power Assist') ,(11, 'Power Supply'),(252, 'PControl externe')
        ] %}
            {% if st == num %}
              {{ text }}
            {%endif%}
        {% endfor %} 

    # Energie batteries- Mise à l'échelle (/10)
    - name: "MP2 Energy charge batterie"
      unique_id: "mp2_energy_charge_batterie"
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"
      state: >-
        {{ states('sensor.mp2_energy_charge_batteries_brut') | float(default=0) | round(1) /10}}
    - name: "MP2 Energy decharge batterie"
      unique_id: "mp2_energy_decharge_batterie"
      unit_of_measurement: "kWh"
      device_class: "energy"
      state_class: "total"
      state: >-
        {{ states('sensor.mp2_energy_decharge_batteries_brut') | float(default=0) | round(1) /10}}

    # Puissance batteries
    - name: "MP2 Pu charge batterie"
      unique_id: "mp2_pu_charge_batterie"
      device_class: "power"
      state_class: "measurement"
      unit_of_measurement: "W"
      state: >-
        {{ max(0, states('sensor.mp2_puissance_batteries') | float(default=0)) }}

    - name: "MP2 Pu decharge batterie"
      unique_id: "mp2_pu_decharge_batterie"
      device_class: "power"
      state_class: "measurement"
      unit_of_measurement: "W"
      state: >-
        {{ max(0, 0 - states('sensor.mp2_puissance_batteries') | float(default=0)) }}

    # Calcul Affichage Import ou Eport dans la carte Tesla
    - name: "Mp2 Affichage import export grid"
      unique_id: "mp2_affichage_import_export_grid"
      state: >-
        {% if (states('sensor.mp2_grid_l1') | int) < 0 %}Export{% else %}Import{% endif %}
      icon: "{% if (states('sensor.mp2_grid_l1') | int) < 0 %}mdi:arrow-left-bold{% else %}mdi:arrow-right-bold{% endif %}"
      device_class: "power"
      state_class: "measurement"